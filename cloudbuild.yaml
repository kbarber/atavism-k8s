steps:
- id: 'ContainerBuild'
  dir: 'containers/atavism'
  name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '-t'
  - 'gcr.io/$PROJECT_ID/atavism:$SHORT_SHA'
  - '.'

- id: ContainerPush
  name: 'gcr.io/cloud-builders/docker'
  dir: 'containers/atavism'
  args:
  - 'push'
  - 'gcr.io/$PROJECT_ID/atavism:$SHORT_SHA'
  waitFor:
  - 'ContainerBuild'

- id: 'HelmLint'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - lint
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor: ['-']

- id: 'HelmDeps'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - dependency
  - update
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor: ['-']

- id: 'HelmPackage'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - package
  - '--version'
  - '1.0.0-$SHORT_SHA'
  - '.'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmDeps'
  - 'HelmLint'

- id: 'HelmCanaryRelease'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - install
  - 'atavism-1.0.0-$SHORT_SHA.tgz'
  - '--atomic'
  - '--namespace'
  - 'test'
  - '--name=atavism-test-$SHORT_SHA'
  - '--description=CanaryRelease'
  - '--replace'
  - '--verify'
  - '--wait'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmPackage'

- id: 'HelmTest'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - test
  - 'atavism-test-$SHORT_SHA'
  - '--cleanup'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmCanaryRelease'

- id: 'HelmCanaryDelete'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - delete
  - '--purge'
  - 'atavism-test-$SHORT_SHA'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=incubator'
  - 'HELM_REPO_URL=https://kubernetes-charts-incubator.storage.googleapis.com '
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmPackage'


- id: 'HelmGcsPush'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - gcs
  - push
  - 'bobsh'
  - 'atavism-1.0.0-$SHORT_SHA.tgz'
  - '--retry'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=bobsh'
  - 'HELM_REPO_URL=gs://bobsh/charts'
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmTest'


- id: 'HelmProdUpgrade'
  name: 'gcr.io/$PROJECT_ID/helm'
  args:
  - upgrade
  - atavism
  - 'atavism-1.0.0-$SHORT_SHA.tgz'
  - '--atomic'
  - '--install'
  - '--verify'
  - '--wait'
  dir: 'charts/atavism'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west2-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=atavism'
  - 'HELM_REPO_NAME=bobsh'
  - 'HELM_REPO_URL=gs://bobsh/charts'
  - 'TILLERLESS=false'
  - 'TILLER_NAMESPACE=kube-system'
  waitFor:
  - 'HelmTest'